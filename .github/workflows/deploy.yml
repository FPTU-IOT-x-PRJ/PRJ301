name: Deploy WAR to Tomcat on EC2

on:
  push:
    branches: ["deploy"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Ant
        run: sudo apt-get install ant -y

      - name: Download Tomcat (for Ant build)
        run: |
          curl -O https://dlcdn.apache.org/tomcat/tomcat-10/v10.1.43/bin/apache-tomcat-10.1.43.tar.gz
          mkdir tomcat10
          tar xzvf apache-tomcat-10.1.43.tar.gz -C tomcat10 --strip-components=1

      - name: Download CopyLibs
        run: |
          mkdir -p lib/CopyLibs
          curl -L -o lib/CopyLibs/org-netbeans-modules-java-j2seproject-copylibstask.jar \
            "https://hub.spigotmc.org/stash/projects/PLUGIN/repos/essentials/raw/lib/CopyLibs/org-netbeans-modules-java-j2seproject-copylibstask.jar?at=88c1b785af81cfe213fb771243f1605d394619ab"

      - name: Build WAR using Ant
        run: |
          ant dist \
            -Dlibs.CopyLibs.classpath=lib/CopyLibs/org-netbeans-modules-java-j2seproject-copylibstask.jar \
            -Dj2ee.server.home=tomcat10

      - name: Debug WAR file
        run: |
          echo "Current directory: $(pwd)"
          find . -name "*.war"

      - name: Upload WAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "dist/EduPlan.war"
          target: "~"

      - name: Inject environment variables and restart Tomcat
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop tomcat

            export DB_USERNAME="${{ secrets.DB_USERNAME }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export DB_URL="${{ secrets.DB_URL }}"
            export MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            export MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            export CLOUDINARY_CLOUD_NAME="${{ secrets.CLOUDINARY_CLOUD_NAME }}"
            export CLOUDINARY_API_KEY="${{ secrets.CLOUDINARY_API_KEY }}"
            export CLOUDINARY_API_SECRET="${{ secrets.CLOUDINARY_API_SECRET }}"

            sudo mkdir -p /etc/systemd/system/tomcat.service.d

            sudo tee /etc/systemd/system/tomcat.service.d/env.conf > /dev/null <<'EOF'
            [Service]
            Environment="DB_USERNAME=${DB_USERNAME}"
            Environment="DB_PASSWORD=${DB_PASSWORD}"
            Environment="DB_URL=jdbc:sqlserver://localhost\\SQLEXPRESS:1433;databaseName=EduPlan"
            Environment="MAIL_USERNAME=${MAIL_USERNAME}"
            Environment="MAIL_PASSWORD=${MAIL_PASSWORD}"
            Environment="CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}"
            Environment="CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}"
            Environment="CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}"
            EOF

            sudo systemctl daemon-reexec
            sudo systemctl daemon-reload

            sudo rm -rf /opt/tomcat10/webapps/EduPlan /opt/tomcat10/webapps/EduPlan.war
            sudo cp dist/EduPlan.war /opt/tomcat10/webapps/

            sudo systemctl start tomcat